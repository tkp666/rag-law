<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Law RAG — 法律智能问答系统</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      color: #2c3e50;
      --primary-color: #3498db;
      --primary-dark: #2980b9;
      --secondary-color: #2c3e50;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --light-bg: #f8f9fa;
      --border-color: #dee2e6;
      --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      font-size: 16px;
      line-height: 1.6;
      display: flex;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      flex: 1;
      display: flex;
      gap: 20px;
    }

    .main-content {
      flex: 1;
      max-width: 900px;
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: var(--card-shadow);
      margin: 20px 0;
      transition: var(--transition);
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      color: var(--secondary-color);
      font-size: 28px;
      margin-bottom: 10px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .header p {
      color: #7f8c8d;
      font-size: 16px;
    }

    .auth-section {
      background: var(--light-bg);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .auth-form {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .auth-input {
      padding: 8px 12px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
    }

    .btn-auth {
      padding: 8px 16px;
      background: var(--secondary-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .input-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--secondary-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    textarea {
      width: 100%;
      min-height: 120px;
      padding: 15px;
      font-size: 16px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      resize: vertical;
      transition: var(--transition);
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      margin-bottom: 25px;
      padding: 15px;
      background: var(--light-bg);
      border-radius: 10px;
    }

    .control-item {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .control-item label {
      margin-bottom: 0;
      font-size: 14px;
      color: #666;
    }

    select, button {
      padding: 12px 16px;
      font-size: 15px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: var(--transition);
    }

    select {
      background: white;
      border: 2px solid var(--border-color);
      min-width: 80px;
    }

    select:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    button {
      background: var(--primary-color);
      color: white;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
    }

    button:hover:not(:disabled) {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    button:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--success-color);
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    .toggle-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status {
      color: #7f8c8d;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .result-container {
      display: none;
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--border-color);
    }

    .result-header h3 {
      color: var(--secondary-color);
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .result-content {
      background: var(--light-bg);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 25px;
      white-space: pre-wrap;
      line-height: 1.7;
      border-left: 4px solid var(--primary-color);
    }

    .retrievals-section h3 {
      color: var(--secondary-color);
      margin: 25px 0 15px 0;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .retrieval {
      background: white;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      border-left: 4px solid #3498db;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: var(--transition);
    }

    .retrieval:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .retrieval-meta {
      color: #666;
      font-size: 14px;
      margin-bottom: 8px;
      padding-bottom: 5px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
    }

    .retrieval-text {
      color: #333;
      line-height: 1.6;
    }

    .thinking-badge {
      display: inline-block;
      padding: 4px 8px;
      background: var(--warning-color);
      color: white;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }

    .source-info {
      font-weight: 500;
    }

    .score-info {
      background: rgba(52, 152, 219, 0.1);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
    }

    .spinner {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* 侧边栏样式 */
    .sidebar {
      width: 300px;
      background: white;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      padding: 20px;
      height: fit-content;
      max-height: calc(100vh - 40px);
      display: flex;
      flex-direction: column;
    }
    
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--border-color);
    }
    
    .sidebar-title {
      color: var(--secondary-color);
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }
    
    .toggle-sidebar-btn {
      background: var(--secondary-color);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .history-list {
      overflow-y: auto;
      flex: 1;
    }
    
    .history-item {
      background: var(--light-bg);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid var(--primary-color);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: var(--transition);
      cursor: pointer;
    }
    
    .history-item:hover {
      background: #e3f2fd;
      transform: translateX(3px);
    }
    
    .history-question {
      font-weight: bold;
      margin-bottom: 8px;
      color: var(--secondary-color);
      font-size: 14px;
      line-height: 1.4;
    }
    
    .history-answer {
      color: #555;
      font-size: 13px;
      line-height: 1.4;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
    }
    
    .history-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
    }
    
    .delete-btn {
      background: var(--danger-color);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }
    
    .delete-btn:hover {
      background: #c0392b;
    }
    
    .sidebar.hidden {
      display: none;
    }

    @media (max-width: 1200px) {
      .container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        max-height: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-content">
      <div class="card">
        <div class="header">
          <h1><i class="fas fa-gavel"></i> 法律智能问答系统</h1>
          <p>基于民法典的检索增强生成（RAG）AI助手</p>
        </div>

        <!-- User Authentication Section -->
        <div class="auth-section">
          <div class="auth-form">
            <input type="text" id="username" class="auth-input" placeholder="用户名">
            <input type="password" id="password" class="auth-input" placeholder="密码">
            <button id="loginBtn" class="btn-auth">登录</button>
            <button id="registerBtn" class="btn-auth">注册</button>
          </div>
          <div class="user-info">
            <span id="userStatus">未登录</span>
          </div>
        </div>

        <div class="input-group">
          <label for="q"><i class="fas fa-question-circle"></i> 请输入您的法律问题：</label>
          <textarea id="q" placeholder="例如：离婚后如何分割夫妻共同财产？合同违约的法律后果是什么？"></textarea>
        </div>

        <div class="controls">
          <div class="control-item">
            <label for="topk"><i class="fas fa-list-ol"></i> 检索数量</label>
            <select id="topk">
              <option value="1">1</option>
              <option value="3" selected>3</option>
              <option value="5">5</option>
            </select>
          </div>

          <div class="control-item">
            <label for="modelToggle"><i class="fas fa-brain"></i> 思考模式</label>
            <div class="toggle-container">
              <label class="switch">
                <input type="checkbox" id="modelToggle">
                <span class="slider"></span>
              </label>
              <span id="modelLabel">基础模式</span>
            </div>
          </div>

          <button id="askBtn">
            <i class="fas fa-paper-plane"></i> 提交问题
          </button>

          <div id="status" class="status">
            <i class="fas fa-check-circle"></i> 就绪
          </div>
        </div>

        <div id="answerArea" class="result-container">
          <div class="result-header">
            <h3><i class="fas fa-robot"></i> AI 回答</h3>
            <span id="modelUsed" class="thinking-badge">基础模式</span>
          </div>
          <div id="answer" class="result-content"></div>

          <div class="retrievals-section">
            <h3><i class="fas fa-search"></i> 检索到的法条依据</h3>
            <div id="retrievals"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 侧边栏 -->
    <div class="sidebar" id="historySidebar">
      <div class="sidebar-header">
        <h3 class="sidebar-title"><i class="fas fa-history"></i> 查询历史</h3>
        <button id="toggleSidebarBtn" class="toggle-sidebar-btn">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="history-list" id="historyList">
        <p id="noHistory">登录后查看历史记录</p>
      </div>
    </div>
  </div>

  <script>
    // 防止脚本重复执行的标志
    if (window.LawRAGApp) {
      console.log("LawRAG App script already loaded, skipping duplicate initialization");
      // 如果已经初始化过，直接更新用户状态
      if (typeof updateUserStatus === 'function') {
        updateUserStatus();
      }
      exit;
    }

    // 设置标志，表明脚本已加载
    window.LawRAGApp = true;

    const askBtn = document.getElementById('askBtn');
    const qEl = document.getElementById('q');
    const statusEl = document.getElementById('status');
    const answerArea = document.getElementById('answerArea');
    const answerEl = document.getElementById('answer');
    const retrievalsEl = document.getElementById('retrievals');
    const topkEl = document.getElementById('topk');
    const modelToggle = document.getElementById('modelToggle');
    const modelLabel = document.getElementById('modelLabel');
    const modelUsed = document.getElementById('modelUsed');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const usernameEl = document.getElementById('username');
    const passwordEl = document.getElementById('password');
    const userStatus = document.getElementById('userStatus');
    const historyList = document.getElementById('historyList');
    const noHistory = document.getElementById('noHistory');
    const historySidebar = document.getElementById('historySidebar');
    const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');

    // 用于存储用户token和状态
    let userToken = localStorage.getItem('userToken') || null;
    let userId = localStorage.getItem('userId') || null;
    let username = localStorage.getItem('username') || null;

    // 防止重复绑定的标志
    let eventListenersAdded = false;

    // Update UI based on user status
    function updateUserStatus() {
      if (userToken && username) {
        userStatus.textContent = `已登录: ${username}`;
        loginBtn.textContent = '登出';
        // 确保登出函数绑定
        loginBtn.onclick = logout;
        // 隐藏用户名和密码输入框，隐藏注册按钮，但保留登出按钮
        document.getElementById('username').style.display = 'none';
        document.getElementById('password').style.display = 'none';
        document.getElementById('registerBtn').style.display = 'none';
        loadHistory();
      } else {
        userStatus.textContent = '未登录';
        loginBtn.textContent = '登录';
        // 确保登录函数绑定
        loginBtn.onclick = handleLogin;
        // 显示用户名和密码输入框，显示注册按钮
        document.getElementById('username').style.display = 'inline-block';
        document.getElementById('password').style.display = 'inline-block';
        document.getElementById('registerBtn').style.display = 'inline-block';
        // 确保历史记录区域显示正确的提示
        historyList.innerHTML = '<p id="noHistory">登录后查看历史记录</p>';
      }
    }

    // Update model label based on toggle
    if (!eventListenersAdded) {
      modelToggle.addEventListener('change', () => {
        if (modelToggle.checked) {
          modelLabel.textContent = '深度思考';
          modelUsed.textContent = '深度思考模式';
          modelUsed.style.backgroundColor = '#f39c12';
        } else {
          modelLabel.textContent = '基础模式';
          modelUsed.textContent = '基础模式';
          modelUsed.style.backgroundColor = '#3498db';
        }
      });
    }

    // Show message using status area instead of alert
    function showMessage(message, type = 'error') {
      let icon, color;
      switch(type) {
        case 'success':
          icon = 'fa-check-circle';
          color = '#27ae60';
          break;
        case 'warning':
          icon = 'fa-exclamation-triangle';
          color = '#f39c12';
          break;
        default: // error
          icon = 'fa-exclamation-triangle';
          color = '#e74c3c';
      }
      statusEl.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
      statusEl.style.color = color;
      
      // 3秒后恢复原始状态
      setTimeout(() => {
        if (statusEl.innerHTML.includes('请求中') === false) {
          statusEl.innerHTML = '<i class="fas fa-check-circle"></i> 就绪';
          statusEl.style.color = '';
        }
      }, 3000);
    }

    // Handle login
    async function handleLogin() {
      const inputUsername = usernameEl.value.trim();
      const password = passwordEl.value.trim();

      if (userStatus.textContent == '未登录' && (!inputUsername || !password)) {
        showMessage('请输入用户名和密码');
        return;
      }

      try {
        const response = await fetch('http://localhost:8001/api/auth/login/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken') || ''  // 如果需要CSRF token
          },
          body: JSON.stringify({ username: inputUsername, password })
        });

        if (!response.ok) {
          const error = await response.json();
          showMessage(`登录失败: ${error.error || response.statusText}`);
          return;
        }

        const data = await response.json();

        // Store user info - 现在使用真正的token
        userToken = data.token;
        userId = data.user_id;
        username = data.username;  // 全局变量赋值

        localStorage.setItem('userToken', userToken);
        localStorage.setItem('userId', userId);
        localStorage.setItem('username', username);

        updateUserStatus();

        // Clear form
        usernameEl.value = '';
        passwordEl.value = '';
        
        showMessage('登录成功', 'success');
      } catch (err) {
        console.error('Login error:', err);
        showMessage('登录请求失败: ' + err.message);
      }
    }

    // Handle registration
    async function handleRegister() {
      const username = usernameEl.value.trim();
      const password = passwordEl.value.trim();

      if (!username || !password) {
        showMessage('请填写用户名和密码');
        return;
      }

      try {
        const response = await fetch('http://localhost:8001/api/auth/register/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken') || ''  // 如果需要CSRF token
          },
          body: JSON.stringify({ username, password })
        });

        if (!response.ok) {
          const error = await response.json();
          showMessage(`注册失败: ${error.error || response.statusText}`);
          return;
        }

        const data = await response.json();
        showMessage('注册成功，请登录', 'success');
      } catch (err) {
        console.error('Registration error:', err);
        showMessage('注册请求失败: ' + err.message);
      }
    }

    // Handle logout
    function logout() {
      userToken = null;
      userId = null;
      username = null;

      localStorage.removeItem('userToken');
      localStorage.removeItem('userId');
      localStorage.removeItem('username');

      // 清空历史记录面板
      historyList.innerHTML = '<p id="noHistory">登录后查看历史记录</p>';

      // 清空主界面的显示内容
      qEl.value = '';
      answerEl.textContent = '';
      retrievalsEl.innerHTML = '';
      answerArea.style.display = 'none';

      updateUserStatus();
      showMessage('已登出', 'success');
    }

    // Load user history
    async function loadHistory() {
      if (!userToken) {
        historyList.innerHTML = '<p id="noHistory">请先登录查看历史记录</p>';
        return;
      }

      try {
        // 直接通过FastAPI获取历史，FastAPI会代理请求到Django
        const response = await fetch(`/history?user_token=${userToken}`);

        if (!response.ok) {
          throw new Error(`服务器错误 ${response.status}`);
        }

        const data = await response.json();

        if (data.history && data.history.length > 0) {
          historyList.innerHTML = '';
          data.history.forEach(item => {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.dataset.id = item.id; // 存储历史记录ID

            historyItem.innerHTML = `
              <div class="history-question">${item.question}</div>
              <div class="history-answer">${item.answer.substring(0, 100)}${item.answer.length > 100 ? '...' : ''}</div>
              <div class="history-actions">
                <button class="delete-btn" onclick="deleteHistoryItem('${item.id}', event)">删除</button>
              </div>
            `;

            // 添加点击事件，用于填充问题和答案
            historyItem.addEventListener('click', function(e) {
              // 阻止删除按钮点击事件冒泡到历史项目上
              if (e.target.classList.contains('delete-btn')) {
                return;
              }
              loadHistoryItem(item);
            });
            
            historyList.appendChild(historyItem);
          });
        } else {
          historyList.innerHTML = '<p id="noHistory">暂无查询历史</p>';
        }
      } catch (err) {
        console.error('Load history error:', err);
        historyList.innerHTML = '<p id="noHistory">获取历史记录失败</p>';
      }
    }
    
    // 加载特定历史记录到主界面
    function loadHistoryItem(item) {
      qEl.value = item.question;
      answerEl.textContent = item.answer;
      
      // 清空之前的检索结果并填充新的
      if (Array.isArray(item.retrievals)) {
        retrievalsEl.innerHTML = '';
        item.retrievals.forEach((r, i) => {
          const div = document.createElement('div');
          div.className = 'retrieval';

          const meta = document.createElement('div');
          meta.className = 'retrieval-meta';

          const sourceInfo = document.createElement('span');
          sourceInfo.className = 'source-info';
          sourceInfo.textContent = `${i+1}. ${r.source || '未知来源'}${r.article_no ? ' | ' + r.article_no : ''}`;

          const scoreInfo = document.createElement('span');
          scoreInfo.className = 'score-info';
          scoreInfo.textContent = `相关度: ${r.score !== null && r.score !== undefined ? Number(r.score).toFixed(3) : 'N/A'}`;

          meta.appendChild(sourceInfo);
          meta.appendChild(scoreInfo);

          const textp = document.createElement('div');
          textp.className = 'retrieval-text';
          textp.textContent = r.text || '';

          div.appendChild(meta);
          div.appendChild(textp);
          retrievalsEl.appendChild(div);
        });
      } else {
        // 如果历史记录没有检索结果，清空检索区域
        retrievalsEl.innerHTML = '';
      }
      
      // 显示答案区域
      answerArea.style.display = 'block';
    }
    
    // 删除历史记录
    async function deleteHistoryItem(id, event) {
      event.stopPropagation(); // 阻止事件冒泡到历史记录项上
      
      if (!confirm('确定要删除这条记录吗？')) {
        return;
      }

      try {
        const response = await fetch(`/history/${id}/delete`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Token ${userToken}`  // 注意使用Token认证
          },
          body: JSON.stringify({})  // 发送空的JSON体
        });

        if (!response.ok) {
          throw new Error(`删除失败 ${response.status}`);
        }

        // 删除成功后刷新历史记录
        loadHistory();
        
        showMessage('记录已删除', 'success');
      } catch (err) {
        console.error('Delete history error:', err);
        showMessage('删除失败: ' + err.message, 'error');
      }
    }

    // 从cookie获取CSRF token的辅助函数
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Ask button click handler
    async function handleAsk() {
      const question = qEl.value.trim();
      if (!question) {
        showMessage('请先输入一个问题');
        return;
      }
      const top_k = parseInt(topkEl.value) || 3;
      const useReasoner = modelToggle.checked; // Whether to use deepseek-reasoner
      const model = useReasoner ? "deepseek-reasoner" : "deepseek-chat"; // Model to use

      // UI updates
      statusEl.innerHTML = '<i class="fas fa-spinner fa-spin spinner"></i> 请求中…';
      statusEl.style.color = '#f39c12';
      askBtn.disabled = true;
      answerArea.style.display = 'none';
      answerEl.textContent = '';
      retrievalsEl.innerHTML = '';

      try {
        const payload = {
          question,
          top_k,
          model  // Add model parameter to the request
        };

        // Add user token if user is logged in
        if (userToken) {
          payload.user_token = userToken;
        }

        const resp = await fetch('/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) {
          const txt = await resp.text();
          throw new Error(`服务器错误 ${resp.status}: ${txt}`);
        }

        const data = await resp.json();

        // Update answer
        answerEl.textContent = data.answer || '(无回答)';

        // Update retrievals
        if (Array.isArray(data.retrievals)) {
          retrievalsEl.innerHTML = '';
          data.retrievals.forEach((r, i) => {
            const div = document.createElement('div');
            div.className = 'retrieval';

            const meta = document.createElement('div');
            meta.className = 'retrieval-meta';

            const sourceInfo = document.createElement('span');
            sourceInfo.className = 'source-info';
            sourceInfo.textContent = `${i+1}. ${r.source || '未知来源'}${r.article_no ? ' | ' + r.article_no : ''}`;

            const scoreInfo = document.createElement('span');
            scoreInfo.className = 'score-info';
            scoreInfo.textContent = `相关度: ${r.score !== null && r.score !== undefined ? Number(r.score).toFixed(3) : 'N/A'}`;

            meta.appendChild(sourceInfo);
            meta.appendChild(scoreInfo);

            const textp = document.createElement('div');
            textp.className = 'retrieval-text';
            textp.textContent = r.text || '';

            div.appendChild(meta);
            div.appendChild(textp);
            retrievalsEl.appendChild(div);
          });
        }

        answerArea.style.display = 'block';
        showMessage('完成', 'success');
        statusEl.style.color = '#27ae60';

        // Reload history to show the new query if user is logged in
        if (userToken) {
          setTimeout(loadHistory, 1000); // Delay to allow backend to save the history
        }
      } catch (err) {
        console.error(err);
        showMessage('请求失败：' + err.message);
        statusEl.style.color = '#e74c3c';
      } finally {
        askBtn.disabled = false;
      }
    }

    // Toggle sidebar visibility
    function toggleSidebar() {
      historySidebar.classList.toggle('hidden');
      if (historySidebar.classList.contains('hidden')) {
        toggleSidebarBtn.innerHTML = '<i class="fas fa-bars"></i>';
      } else {
        toggleSidebarBtn.innerHTML = '<i class="fas fa-times"></i>';
      }
    }

    // Add event listeners only once
    if (!eventListenersAdded) {
      askBtn.addEventListener('click', handleAsk);
      registerBtn.addEventListener('click', handleRegister);
      toggleSidebarBtn.addEventListener('click', toggleSidebar);
      eventListenersAdded = true;
    }

    // Initialize UI
    updateUserStatus();
    
    // 暴露删除函数到全局，以便在HTML中使用
    window.deleteHistoryItem = deleteHistoryItem;
  </script>
</body>
</html>